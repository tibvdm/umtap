---
title: "K-meer consensus analyse"
author: "Aranka Steyaert"
date: "20 February 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Kraken

```{r include=FALSE}
tot.reads <- 10000
present.taxons <- read.csv("Kraken_HiSeq_presentTaxons", header=FALSE)
true.lineages <- read.csv("Kraken_HiSeq_Lineages",fill = TRUE, header=FALSE)
reads.consensus <- read.csv("Kraken_HiSeq_readConsensus.csv", header=FALSE)
reads.consensus[,2] <- as.factor(reads.consensus[,2])
reads.consensus[,5] <- as.factor(reads.consensus[,5])
reads.consensus[,ncol(reads.consensus)+1] <- reads.consensus[,4]-reads.consensus[,3]
reads.consensus[,ncol(reads.consensus)+1] <- "null"
reads.consensus[,ncol(reads.consensus)+1] <- "null"
reads.consensus[,ncol(reads.consensus)+1] <- FALSE
for(i in 1:nrow(reads.consensus)){
  reads.consensus[i,7] <- as.character(present.taxons[which(present.taxons[,2]==reads.consensus[i,5]),3])
  reads.consensus[i,8] <- as.character(present.taxons[which(present.taxons[,2]==reads.consensus[i,5]),4])
  if(any(as.character(reads.consensus[i,7])==true.lineages)||as.character(reads.consensus[i,7])=="root"){
    reads.consensus[i,9] <- TRUE
  }else{
    reads.consensus[i,9] <- FALSE
  }
}
reads.consensus[,7] <- as.factor(reads.consensus[,7])
reads.consensus[,8] <- as.factor(reads.consensus[,8])
colnames(reads.consensus) <- c("Header","Frame","start","end","taxonID","n_kmers","taxonName","taxonRank","correct")
summary(reads.consensus)
CLASSES = c("no rank", "superkingdom", "kingdom", "subkingdom", "superphylum", "phylum",
            "subphylum", "superclass", "class", "subclass", "infraclass", "superorder", "order", "suborder", 
            "infraorder", "parvorder", "superfamily", "family", "subfamily", "tribe", "subtribe", "genus",
            "subgenus", "species group", "species subgroup", "species", "subspecies", "varietas", "forma")
reads.consensus[,"taxonRank"] <- ordered(reads.consensus[,"taxonRank"], levels = CLASSES)
```

```{r echo=FALSE, fig.width=11}
  barplot(table(reads.consensus[,"correct"],droplevels(reads.consensus[,"taxonRank"])), col=c("red","green"), cex.names = 0.8)
```

```{r, size="tiny"}
  reads.consensus[reads.consensus[,"taxonRank"]=="subspecies",c(1,7)]
```

```{r echo=FALSE, fig.width=9}
  barplot(table(as.factor(reads.consensus[reads.consensus[,"correct"]==TRUE,"n_kmers"])), main= "Match- lengte, correcte classificatie")
barplot(table(as.factor(reads.consensus[reads.consensus[,"correct"]==FALSE,"n_kmers"])), main= "Match- lengte, foute classificatie")
```

### Precisie en sensitiviteit

```{r}
voorspellingen <- nrow(reads.consensus)
genera <- sum(reads.consensus[,"taxonRank"]>="genus")
cor.genera <- sum(reads.consensus[reads.consensus[,"taxonRank"]>="genus","correct"]==TRUE)
incor.voorspelling <- sum(reads.consensus[reads.consensus[,"taxonRank"]>="genus","correct"]==FALSE)
precision <- cor.genera/genera
#sensitivity 
```

???

$TP = $ alles wat boven genus juist geclassificeerd wordt
$TN = $ ?? (alles zonder classificatie en zonder proteïne)
$FP = $ alles wat boven genus fout geclassificeerd wordt
$FN = $ alles wat onder genus geclassificeerd wordt (en wel een proteïne bevatte)

specificiteit:

* = $\frac{TP}{TP+FP}$
* = $\frac{\#\text{correct voorspelde genera}}{\#\text{voorspelde genera}}$ (Stijn)
* = $\frac{\#\text{correct voorspelde genera}}{\#\text{voorspelde genera} + \#\text{incorrecte voorspellingen boven genus}}$ (Kraken)


sensitiviteit:

* = $\frac{TP}{TP+FN}$
* = $\frac{\#\text{correct voorspelde genera}}{\#\text{reads met gekend genus} + \#\text{incorrecte voorspellingen boven genus}}$ (Stijn)
* = $\frac{\#\text{correct voorspelde genera}}{\#\text{voorspelde genera}}$ (Kraken)

???
 
 .                      | Seed-extend Kmer          |   Stijn (HiSeq zonder filter)
----------------------- | ------------------------  | -------------------------------
Aantal reads            | `r tot.reads`             | 10000
Aantal voorspellingen   | `r voorspellingen`        | 4875
Voorspelde genera       | `r genera`                | 1922
Correcte genera         | `r cor.genera`            | 1501
Incorrecte genera       | `r incor.voorspelling`    | 115
Precisie                | `r precision`             | $73.69\%$
Sensitiviteit           |                           | $15.01\%$
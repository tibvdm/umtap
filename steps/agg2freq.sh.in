@HASHBANG@
#
# Takes a FASTQ file as input and runs the Unipept pipeline to find
# out the species in this sample.
# Outputs an list of "frequency species-name" lines, ordered per frequency.

set -euo pipefail

dir="$(dirname "$BASH_SOURCE")"

function usage() {
    echo "Usage: $(basename $0) [options]" >&2
    echo >&2
    echo "Options:" >&2
    echo "  -h, --help            Display this message." >&2
    echo >&2
}

function parse_arguments() {
    local OPTIONS_SHORT='h'
    local OPTIONS_LONG='help'

    local options=$(getopt -n "$0" -o "$OPTIONS_SHORT" --long "$OPTIONS_LONG"  -- "$@")
    eval set -- $options
    while true; do
        case "$1" in
            # TODO -> add rank at which we will filter
            -h|--help)
                usage
                exit ;;
            --)
                shift
                break ;;
            *)
                break ;;
        esac
        shift
    done

    # Don't allow arguments
    if [[ $# -ne 0 ]]; then
        echo "Please supply the input through stdin. No arguments allowed" >&2
        echo >&2
        usage
        exit 1
    fi
}

parse_arguments

@GREP@ '^[^>]' | \

    # Count how many times each taxon was detected
    @SORT@ | uniq -c | \

    # Optional: replace space with tab
    @SED@ -r 's/^( *[^ ]+) +/\1\t/' | \

    # Sort on nr of detecteds, from most detected to least detected
    @SORT@ -gr

    # Filter only frequencies of species or lower ranks
    # grep ',\(species\|subspecies\|varietas\|forma\)$'

